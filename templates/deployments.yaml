---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Release.Name }}-st2auth-enterprise
  labels:
    app: st2auth
    tier: backend
    vendor: stackstorm
    support: {{ template "supportMethod" . }}
    chart: {{ .Chart.Name }}-{{ .Chart.Version }}
    release: {{ .Release.Name }}
    heritage: {{ .Release.Service }}
spec:
  selector:
    matchLabels:
      app: st2auth
      support: {{ template "supportMethod" . }}
      release: {{ .Release.Name }}
  # https://docs.stackstorm.com/reference/ha.html#st2auth
  # Multiple st2auth processes can be behind a load balancer in an active-active configuration.
  replicas: {{ default 2 .Values.st2auth.replicas }}
  template:
    metadata:
      labels:
        app: st2auth
        tier: backend
        vendor: stackstorm
        support: {{ template "supportMethod" . }}
        chart: {{ .Chart.Name }}-{{ .Chart.Version }}
        release: {{ .Release.Name }}
        heritage: {{ .Release.Service }}
      annotations:
        checksum/config: {{ include (print $.Template.BasePath "/configmaps_st2-conf.yaml") . | sha256sum }}
        checksum/auth: {{ include (print $.Template.BasePath "/secrets_st2auth.yaml") . | sha256sum }}
    spec:
      {{- if .Values.enterprise.enabled }}
      imagePullSecrets:
      - name: {{ .Release.Name }}-st2-license
      {{- end }}
      # Sidecar container for generating .htpasswd with st2 username & password pair and sharing produced file with the main st2auth container
      initContainers:
      - name: generate-htpasswd
        image: "{{ .Values.image.repository }}/st2auth-enterprise:{{ .Chart.AppVersion }}"
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        env:
        - name: ST2_AUTH_USERNAME
          valueFrom:
            secretKeyRef:
              name: {{ .Release.Name }}-st2-auth
              key: username
        - name: ST2_AUTH_PASSWORD
          valueFrom:
            secretKeyRef:
              name: {{ .Release.Name }}-st2-auth
              key: password
        volumeMounts:
        - name: htpasswd-vol
          mountPath: /tmp/st2
        command:
          - 'sh'
          - '-ec'
          - printf "${ST2_AUTH_USERNAME}:$(openssl passwd -apr1 "${ST2_AUTH_PASSWORD}")\n" > /tmp/st2/htpasswd
      containers:
      - name: st2auth-enterprise
        image: "{{ .Values.image.repository }}/st2auth-enterprise:{{ .Chart.AppVersion }}"
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        ports:
        - containerPort: 9100
        # TODO: Add liveness/readiness probes (#3)
        #livenessProbe:
        #readinessProbe:
        envFrom:
        - configMapRef:
            name: {{ .Release.Name }}-st2-urls
        volumeMounts:
        - name: st2-config-vol
          mountPath: /etc/st2/st2.docker.conf
          subPath: st2.docker.conf
        - name: st2-config-vol
          mountPath: /etc/st2/st2.user.conf
          subPath: st2.user.conf
        - name: htpasswd-vol
          mountPath: /etc/st2/htpasswd
          subPath: htpasswd
          readOnly: true
        resources:
{{ toYaml .Values.st2auth.resources | indent 10 }}
      volumes:
        - name: st2-config-vol
          configMap:
            name: {{ .Release.Name }}-st2-config
        - name: htpasswd-vol
          emptyDir:
            medium: Memory
    {{- with .Values.st2auth.nodeSelector }}
      nodeSelector:
{{ toYaml . | indent 8 }}
    {{- end }}
    {{- with .Values.st2auth.affinity }}
      affinity:
{{ toYaml . | indent 8 }}
    {{- end }}
    {{- with .Values.st2auth.tolerations }}
      tolerations:
{{ toYaml . | indent 8 }}
    {{- end }}

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Release.Name }}-st2api-enterprise
  labels:
    app: st2api
    tier: backend
    vendor: stackstorm
    support: {{ template "supportMethod" . }}
    chart: {{ .Chart.Name }}-{{ .Chart.Version }}
    release: {{ .Release.Name }}
    heritage: {{ .Release.Service }}
spec:
  selector:
    matchLabels:
      app: st2api
      support: {{ template "supportMethod" . }}
      release: {{ .Release.Name }}
  # https://docs.stackstorm.com/reference/ha.html#st2api
  # Multiple st2api process can be behind a load balancer in an active-active configuration.
  replicas: {{ default 2 .Values.st2api.replicas }}
  template:
    metadata:
      labels:
        app: st2api
        tier: backend
        vendor: stackstorm
        support: {{ template "supportMethod" . }}
        chart: {{ .Chart.Name }}-{{ .Chart.Version }}
        release: {{ .Release.Name }}
        heritage: {{ .Release.Service }}
      annotations:
        checksum/config: {{ include (print $.Template.BasePath "/configmaps_st2-conf.yaml") . | sha256sum }}
    spec:
      {{- if .Values.enterprise.enabled }}
      imagePullSecrets:
      - name: {{ .Release.Name }}-st2-license
      {{- end }}
      {{- if .Values.st2.packs.image.repository }}
      initContainers:
      # Merge packs and virtualenvs from st2api-enterprise with those from the st2.packs image
      # Custom packs
      - name: st2-custom-packs
        image: "{{ .Values.st2.packs.image.repository }}/{{ .Values.st2.packs.image.name }}:{{ .Values.st2.packs.image.tag }}"
        imagePullPolicy: {{ .Values.st2.packs.image.pullPolicy | quote }}
        volumeMounts:
        - name: st2-packs-vol
          mountPath: /opt/stackstorm/packs-shared
        - name: st2-virtualenvs-vol
          mountPath: /opt/stackstorm/virtualenvs-shared
        command:
          - 'sh'
          - '-ec'
          - |
            /bin/cp -aR /opt/stackstorm/packs/. /opt/stackstorm/packs-shared &&
            /bin/cp -aR /opt/stackstorm/virtualenvs/. /opt/stackstorm/virtualenvs-shared
      # System packs
      - name: st2-system-packs
        image: "{{ .Values.image.repository }}/st2actionrunner-enterprise:{{ .Chart.AppVersion }}"
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        volumeMounts:
        - name: st2-packs-vol
          mountPath: /opt/stackstorm/packs-shared
        - name: st2-virtualenvs-vol
          mountPath: /opt/stackstorm/virtualenvs-shared
        command:
          - 'sh'
          - '-ec'
          - |
            /bin/cp -aR /opt/stackstorm/packs/. /opt/stackstorm/packs-shared &&
            /bin/cp -aR /opt/stackstorm/virtualenvs/. /opt/stackstorm/virtualenvs-shared
      {{- end }}
      containers:
      - name: st2api-enterprise
        image: "{{ .Values.image.repository }}/st2api-enterprise:{{ .Chart.AppVersion }}"
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        ports:
        - containerPort: 9101
        # TODO: Add liveness/readiness probes (#3)
        #livenessProbe:
        #readinessProbe:
        envFrom:
        - configMapRef:
            name: {{ .Release.Name }}-st2-urls
        volumeMounts:
        - name: st2-config-vol
          mountPath: /etc/st2/st2.docker.conf
          subPath: st2.docker.conf
        - name: st2-config-vol
          mountPath: /etc/st2/st2.user.conf
          subPath: st2.user.conf
        {{- if .Values.st2.packs.image.repository }}
        - name: st2-packs-vol
          mountPath: /opt/stackstorm/packs
          readOnly: true
        - name: st2-virtualenvs-vol
          mountPath: /opt/stackstorm/virtualenvs
          readOnly: true
        {{- end }}
        resources:
{{ toYaml .Values.st2api.resources | indent 10 }}
      volumes:
        - name: st2-config-vol
          configMap:
            name: {{ .Release.Name }}-st2-config
        {{- if .Values.st2.packs.image.repository }}
        - name: st2-packs-vol
          emptyDir: {}
        - name: st2-virtualenvs-vol
          emptyDir: {}
        {{- end }}
    {{- with .Values.st2api.nodeSelector }}
      nodeSelector:
{{ toYaml . | indent 8 }}
    {{- end }}
    {{- with .Values.st2api.affinity }}
      affinity:
{{ toYaml . | indent 8 }}
    {{- end }}
    {{- with .Values.st2api.tolerations }}
      tolerations:
{{ toYaml . | indent 8 }}
    {{- end }}

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Release.Name }}-st2stream-enterprise
  labels:
    app: st2stream
    tier: backend
    vendor: stackstorm
    support: {{ template "supportMethod" . }}
    chart: {{ .Chart.Name }}-{{ .Chart.Version }}
    release: {{ .Release.Name }}
    heritage: {{ .Release.Service }}
spec:
  selector:
    matchLabels:
      app: st2stream
      support: {{ template "supportMethod" . }}
      release: {{ .Release.Name }}
  # https://docs.stackstorm.com/reference/ha.html#st2stream
  # Multiple st2stream process can be behind a load balancer in an active-active configuration.
  replicas: {{ default 2 .Values.st2stream.replicas }}
  template:
    metadata:
      labels:
        app: st2stream
        tier: backend
        vendor: stackstorm
        support: {{ template "supportMethod" . }}
        chart: {{ .Chart.Name }}-{{ .Chart.Version }}
        release: {{ .Release.Name }}
        heritage: {{ .Release.Service }}
      annotations:
        checksum/config: {{ include (print $.Template.BasePath "/configmaps_st2-conf.yaml") . | sha256sum }}
    spec:
      {{- if .Values.enterprise.enabled }}
      imagePullSecrets:
      - name: {{ .Release.Name }}-st2-license
      {{- end }}
      containers:
      - name: st2stream-enterprise
        image: "{{ .Values.image.repository }}/st2stream-enterprise:{{ .Chart.AppVersion }}"
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        ports:
        - containerPort: 9102
        # TODO: Add liveness/readiness probes (#3)
        #livenessProbe:
        #readinessProbe:
        envFrom:
        - configMapRef:
            name: {{ .Release.Name }}-st2-urls
        volumeMounts:
        - name: st2-config-vol
          mountPath: /etc/st2/st2.docker.conf
          subPath: st2.docker.conf
        - name: st2-config-vol
          mountPath: /etc/st2/st2.user.conf
          subPath: st2.user.conf
        resources:
{{ toYaml .Values.st2stream.resources | indent 10 }}
      volumes:
        - name: st2-config-vol
          configMap:
            name: {{ .Release.Name }}-st2-config
    {{- with .Values.st2stream.nodeSelector }}
      nodeSelector:
{{ toYaml . | indent 8 }}
    {{- end }}
    {{- with .Values.st2stream.affinity }}
      affinity:
{{ toYaml . | indent 8 }}
    {{- end }}
    {{- with .Values.st2stream.tolerations }}
      tolerations:
{{ toYaml . | indent 8 }}
    {{- end }}

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Release.Name }}-st2web-enterprise
  labels:
    app: st2web
    tier: frontend
    vendor: stackstorm
    support: {{ template "supportMethod" . }}
    chart: {{ .Chart.Name }}-{{ .Chart.Version }}
    release: {{ .Release.Name }}
    heritage: {{ .Release.Service }}
spec:
  selector:
    matchLabels:
      app: st2web
      support: {{ template "supportMethod" . }}
      release: {{ .Release.Name }}
  replicas: {{ default 2 .Values.st2web.replicas }}
  template:
    metadata:
      labels:
        app: st2web
        tier: frontend
        vendor: stackstorm
        support: {{ template "supportMethod" . }}
        chart: {{ .Chart.Name }}-{{ .Chart.Version }}
        release: {{ .Release.Name }}
        heritage: {{ .Release.Service }}
    spec:
      {{- if .Values.enterprise.enabled }}
      imagePullSecrets:
      - name: {{ .Release.Name }}-st2-license
      {{- end }}
      containers:
      - name: st2web-enterprise
        image: "{{ .Values.image.repository }}/st2web-enterprise:{{ .Chart.AppVersion }}"
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        ports:
        - containerPort: 443
        # Probe to check if app is running. Failure will lead to a pod restart.
        livenessProbe:
          httpGet:
            scheme: HTTPS
            path: /
            port: 443
          initialDelaySeconds: 1
        # Probe to check if app is ready to serve traffic. Failure will lead to temp stop serving traffic.
        # TODO: Failing to add readinessProbe, since st2 requires authorization (401) and we don't have `/healthz` endpoints yet (https://github.com/StackStorm/st2/issues/4020)
#        readinessProbe:
#          httpGet:
#            # Probes can't check several endpoints, - this should be implemented on app side (@see https://www.ianlewis.org/en/using-kubernetes-health-checks)
#            # Also multiple liveness checks are not available (@see https://github.com/kubernetes/kubernetes/issues/37218)
#            # So checking ST2_API only
#            scheme: HTTPS
#            path: /api/
#            port: 443
#          initialDelaySeconds: 3
        envFrom:
        - configMapRef:
            name: {{ .Release.Name }}-st2-urls
            optional: true
        volumeMounts:
        - name: st2web-ssl-cert
          mountPath: /etc/ssl/st2/
          readOnly: true
        resources:
{{ toYaml .Values.st2web.resources | indent 10 }}
      volumes:
      - name: st2web-ssl-cert
        secret:
          secretName: {{ .Release.Name }}-st2web
          items:
          - key: ssl_certificate
            path: st2.crt
            # 0400 file permission
            mode: 256
          - key: ssl_certificate_key
            path: st2.key
            # 0400 file permission
            mode: 256
    {{- with .Values.st2web.nodeSelector }}
      nodeSelector:
{{ toYaml . | indent 8 }}
    {{- end }}
    {{- with .Values.st2web.affinity }}
      affinity:
{{ toYaml . | indent 8 }}
    {{- end }}
    {{- with .Values.st2web.tolerations }}
      tolerations:
{{ toYaml . | indent 8 }}
    {{- end }}

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Release.Name }}-st2rulesengine-enterprise
  labels:
    app: st2rulesengine
    tier: backend
    vendor: stackstorm
    support: {{ template "supportMethod" . }}
    chart: {{ .Chart.Name }}-{{ .Chart.Version }}
    release: {{ .Release.Name }}
    heritage: {{ .Release.Service }}
spec:
  selector:
    matchLabels:
      app: st2rulesengine
      support: {{ template "supportMethod" . }}
      release: {{ .Release.Name }}
  # https://docs.stackstorm.com/reference/ha.html#st2rulesengine
  # Multiple st2rulesengine processes can run in active-active with only connections to MongoDB and RabbitMQ. All these will share the TriggerInstance load and naturally pick up more work if one or more of the processes becomes unavailable.
  replicas: {{ default 2 .Values.st2rulesengine.replicas }}
  template:
    metadata:
      labels:
        app: st2rulesengine
        tier: backend
        vendor: stackstorm
        support: {{ template "supportMethod" . }}
        chart: {{ .Chart.Name }}-{{ .Chart.Version }}
        release: {{ .Release.Name }}
        heritage: {{ .Release.Service }}
      annotations:
        checksum/config: {{ include (print $.Template.BasePath "/configmaps_st2-conf.yaml") . | sha256sum }}
    spec:
      {{- if .Values.enterprise.enabled }}
      imagePullSecrets:
      - name: {{ .Release.Name }}-st2-license
      {{- end }}
      containers:
      - name: st2rulesengine-enterprise
        image: "{{ .Values.image.repository }}/st2rulesengine-enterprise:{{ .Chart.AppVersion }}"
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        # TODO: Add liveness/readiness probes (#3)
        #livenessProbe:
        #readinessProbe:
        envFrom:
        - configMapRef:
            name: {{ .Release.Name }}-st2-urls
        volumeMounts:
        - name: st2-config-vol
          mountPath: /etc/st2/st2.docker.conf
          subPath: st2.docker.conf
        - name: st2-config-vol
          mountPath: /etc/st2/st2.user.conf
          subPath: st2.user.conf
        resources:
{{ toYaml .Values.st2rulesengine.resources | indent 10 }}
      volumes:
        - name: st2-config-vol
          configMap:
            name: {{ .Release.Name }}-st2-config
    {{- with .Values.st2rulesengine.nodeSelector }}
      nodeSelector:
{{ toYaml . | indent 8 }}
    {{- end }}
    {{- with .Values.st2rulesengine.affinity }}
      affinity:
{{ toYaml . | indent 8 }}
    {{- end }}
    {{- with .Values.st2rulesengine.tolerations }}
      tolerations:
{{ toYaml . | indent 8 }}
    {{- end }}

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Release.Name }}-st2timersengine-enterprise
  labels:
    app: st2timersengine
    tier: backend
    vendor: stackstorm
    support: {{ template "supportMethod" . }}
    chart: {{ .Chart.Name }}-{{ .Chart.Version }}
    release: {{ .Release.Name }}
    heritage: {{ .Release.Service }}
spec:
  selector:
    matchLabels:
      app: st2timersengine
      support: {{ template "supportMethod" . }}
      release: {{ .Release.Name }}
  # https://docs.stackstorm.com/reference/ha.html#st2timersengine
  # Only single replica is created as timersengine can't work in active-active mode at the moment and it relies on
  # K8s failover/reschedule capabilities to address cases when the process fails.
  replicas: 1
  template:
    metadata:
      labels:
        app: st2timersengine
        tier: backend
        vendor: stackstorm
        support: {{ template "supportMethod" . }}
        chart: {{ .Chart.Name }}-{{ .Chart.Version }}
        release: {{ .Release.Name }}
        heritage: {{ .Release.Service }}
      annotations:
        checksum/config: {{ include (print $.Template.BasePath "/configmaps_st2-conf.yaml") . | sha256sum }}
    spec:
      {{- if .Values.enterprise.enabled }}
      imagePullSecrets:
      - name: {{ .Release.Name }}-st2-license
      {{- end }}
      containers:
      - name: st2timersengine-enterprise
        image: "{{ .Values.image.repository }}/st2timersengine-enterprise:{{ .Chart.AppVersion }}"
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        # TODO: Add liveness/readiness probes (#3)
        #livenessProbe:
        #readinessProbe:
        envFrom:
        - configMapRef:
            name: {{ .Release.Name }}-st2-urls
        volumeMounts:
        - name: st2-config-vol
          mountPath: /etc/st2/st2.docker.conf
          subPath: st2.docker.conf
        - name: st2-config-vol
          mountPath: /etc/st2/st2.user.conf
          subPath: st2.user.conf
        resources:
{{ toYaml .Values.st2timersengine.resources | indent 10 }}
      volumes:
        - name: st2-config-vol
          configMap:
            name: {{ .Release.Name }}-st2-config
    {{- with .Values.st2timersengine.nodeSelector }}
      nodeSelector:
{{ toYaml . | indent 8 }}
    {{- end }}
    {{- with .Values.st2timersengine.affinity }}
      affinity:
{{ toYaml . | indent 8 }}
    {{- end }}
    {{- with .Values.st2timersengine.tolerations }}
      tolerations:
{{ toYaml . | indent 8 }}
    {{- end }}

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Release.Name }}-st2workflowengine-enterprise
  labels:
    app: st2workflowengine
    tier: backend
    vendor: stackstorm
    support: {{ template "supportMethod" . }}
    chart: {{ .Chart.Name }}-{{ .Chart.Version }}
    release: {{ .Release.Name }}
    heritage: {{ .Release.Service }}
spec:
  selector:
    matchLabels:
      app: st2workflowengine
      support: {{ template "supportMethod" . }}
      release: {{ .Release.Name }}
  # https://docs.stackstorm.com/reference/ha.html#st2workflowengine
  # Multiple st2workflowengine processes can run in active-active mode and will share the load and pick up more work if one or more of the processes become available.
  replicas: {{ default 2 .Values.st2workflowengine.replicas }}
  template:
    metadata:
      labels:
        app: st2workflowengine
        tier: backend
        vendor: stackstorm
        support: {{ template "supportMethod" . }}
        chart: {{ .Chart.Name }}-{{ .Chart.Version }}
        release: {{ .Release.Name }}
        heritage: {{ .Release.Service }}
      annotations:
        checksum/config: {{ include (print $.Template.BasePath "/configmaps_st2-conf.yaml") . | sha256sum }}
    spec:
      {{- if .Values.enterprise.enabled }}
      imagePullSecrets:
      - name: {{ .Release.Name }}-st2-license
      {{- end }}
      containers:
      - name: st2workflowengine-enterprise
        image: "{{ .Values.image.repository }}/st2workflowengine-enterprise:{{ .Chart.AppVersion }}"
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        # TODO: Add liveness/readiness probes (#3)
        #livenessProbe:
        #readinessProbe:
        envFrom:
        - configMapRef:
            name: {{ .Release.Name }}-st2-urls
        volumeMounts:
        - name: st2-config-vol
          mountPath: /etc/st2/st2.docker.conf
          subPath: st2.docker.conf
        - name: st2-config-vol
          mountPath: /etc/st2/st2.user.conf
          subPath: st2.user.conf
        resources:
{{ toYaml .Values.st2workflowengine.resources | indent 10 }}
      volumes:
        - name: st2-config-vol
          configMap:
            name: {{ .Release.Name }}-st2-config
    {{- with .Values.st2workflowengine.nodeSelector }}
      nodeSelector:
{{ toYaml . | indent 8 }}
    {{- end }}
    {{- with .Values.st2workflowengine.affinity }}
      affinity:
{{ toYaml . | indent 8 }}
    {{- end }}
    {{- with .Values.st2workflowengine.tolerations }}
      tolerations:
{{ toYaml . | indent 8 }}
    {{- end }}

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Release.Name }}-st2notifier-enterprise
  labels:
    app: st2notifier
    tier: backend
    vendor: stackstorm
    support: {{ template "supportMethod" . }}
    chart: {{ .Chart.Name }}-{{ .Chart.Version }}
    release: {{ .Release.Name }}
    heritage: {{ .Release.Service }}
spec:
  selector:
    matchLabels:
      app: st2notifier
      support: {{ template "supportMethod" . }}
      release: {{ .Release.Name }}
  # https://docs.stackstorm.com/reference/ha.html#st2notifier
  # st2notifier runs in active-active mode and requires for that coordination backend like Redis or Zookeeper
  replicas: {{ default 2 .Values.st2notifier.replicas }}
  template:
    metadata:
      labels:
        app: st2notifier
        tier: backend
        vendor: stackstorm
        support: {{ template "supportMethod" . }}
        chart: {{ .Chart.Name }}-{{ .Chart.Version }}
        release: {{ .Release.Name }}
        heritage: {{ .Release.Service }}
      annotations:
        checksum/config: {{ include (print $.Template.BasePath "/configmaps_st2-conf.yaml") . | sha256sum }}
    spec:
      {{- if .Values.enterprise.enabled }}
      imagePullSecrets:
      - name: {{ .Release.Name }}-st2-license
      {{- end }}
      containers:
      - name: st2notifier-enterprise
        image: "{{ .Values.image.repository }}/st2notifier-enterprise:{{ .Chart.AppVersion }}"
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        # TODO: Add liveness/readiness probes (#3)
        #livenessProbe:
        #readinessProbe:
        envFrom:
        - configMapRef:
            name: {{ .Release.Name }}-st2-urls
        volumeMounts:
        - name: st2-config-vol
          mountPath: /etc/st2/st2.docker.conf
          subPath: st2.docker.conf
        - name: st2-config-vol
          mountPath: /etc/st2/st2.user.conf
          subPath: st2.user.conf
        resources:
{{ toYaml .Values.st2notifier.resources | indent 10 }}
      volumes:
        - name: st2-config-vol
          configMap:
            name: {{ .Release.Name }}-st2-config
    {{- with .Values.st2notifier.nodeSelector }}
      nodeSelector:
{{ toYaml . | indent 8 }}
    {{- end }}
    {{- with .Values.st2notifier.affinity }}
      affinity:
{{ toYaml . | indent 8 }}
    {{- end }}
    {{- with .Values.st2notifier.tolerations }}
      tolerations:
{{ toYaml . | indent 8 }}
    {{- end }}

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Release.Name }}-st2sensorcontainer-enterprise
  labels:
    app: st2sensorcontainer
    tier: backend
    vendor: stackstorm
    support: {{ template "supportMethod" . }}
    chart: {{ .Chart.Name }}-{{ .Chart.Version }}
    release: {{ .Release.Name }}
    heritage: {{ .Release.Service }}
spec:
  selector:
    matchLabels:
      app: st2sensorcontainer
      support: {{ template "supportMethod" . }}
      release: {{ .Release.Name }}
  # https://docs.stackstorm.com/reference/ha.html#st2sensorcontainer
  # It is possible to run st2sensorcontainer in HA mode by running one process on each compute instance. Each sensor node needs to be
  # provided with proper partition information to share work with other sensor nodes so that the same sensor does not run on different nodes.
  # See Partitioning Sensors for information on how to partition sensors.
  # TODO: Re-work to use single-sensor-per-container mode instead of running 1 node. Proper implementation is possible with Helm templating (#4)
  replicas: 1
  template:
    metadata:
      labels:
        app: st2sensorcontainer
        tier: backend
        vendor: stackstorm
        support: {{ template "supportMethod" . }}
        chart: {{ .Chart.Name }}-{{ .Chart.Version }}
        release: {{ .Release.Name }}
        heritage: {{ .Release.Service }}
      annotations:
        checksum/config: {{ include (print $.Template.BasePath "/configmaps_st2-conf.yaml") . | sha256sum }}
    spec:
      {{- if .Values.enterprise.enabled }}
      imagePullSecrets:
      - name: {{ .Release.Name }}-st2-license
      {{- end }}
      {{- if .Values.st2.packs.image.repository }}
      initContainers:
      # Merge packs and virtualenvs from st2sensorcontainer-enterprise with those from the st2.packs image
      # Custom packs
      - name: st2-custom-packs
        image: "{{ .Values.st2.packs.image.repository }}/{{ .Values.st2.packs.image.name }}:{{ .Values.st2.packs.image.tag }}"
        imagePullPolicy: {{ .Values.st2.packs.image.pullPolicy | quote }}
        volumeMounts:
        - name: st2-packs-vol
          mountPath: /opt/stackstorm/packs-shared
        - name: st2-virtualenvs-vol
          mountPath: /opt/stackstorm/virtualenvs-shared
        command:
          - 'sh'
          - '-ec'
          - |
            /bin/cp -aR /opt/stackstorm/packs/. /opt/stackstorm/packs-shared &&
            /bin/cp -aR /opt/stackstorm/virtualenvs/. /opt/stackstorm/virtualenvs-shared
      # System packs
      - name: st2-system-packs
        image: "{{ .Values.image.repository }}/st2actionrunner-enterprise:{{ .Chart.AppVersion }}"
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        volumeMounts:
        - name: st2-packs-vol
          mountPath: /opt/stackstorm/packs-shared
        command:
          - 'sh'
          - '-ec'
          - |
            /bin/cp -aR /opt/stackstorm/packs/. /opt/stackstorm/packs-shared &&
            /bin/cp -aR /opt/stackstorm/virtualenvs/. /opt/stackstorm/virtualenvs-shared
      {{- end }}
      containers:
      - name: st2sensorcontainer-enterprise
        image: "{{ .Values.image.repository }}/st2sensorcontainer-enterprise:{{ .Chart.AppVersion }}"
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        # TODO: Add liveness/readiness probes (#3)
        #livenessProbe:
        #readinessProbe:
        envFrom:
        - configMapRef:
            name: {{ .Release.Name }}-st2-urls
        volumeMounts:
        - name: st2-config-vol
          mountPath: /etc/st2/st2.docker.conf
          subPath: st2.docker.conf
        - name: st2-config-vol
          mountPath: /etc/st2/st2.user.conf
          subPath: st2.user.conf
        {{- if .Values.st2.packs.image.repository }}
        - name: st2-packs-vol
          mountPath: /opt/stackstorm/packs
          readOnly: true
        - name: st2-virtualenvs-vol
          mountPath: /opt/stackstorm/virtualenvs
          readOnly: true
        {{- end }}
        resources:
{{ toYaml .Values.st2sensorcontainer.resources | indent 10 }}
      volumes:
        - name: st2-config-vol
          configMap:
            name: {{ .Release.Name }}-st2-config
        {{- if .Values.st2.packs.image.repository }}
        - name: st2-packs-vol
          emptyDir: {}
        - name: st2-virtualenvs-vol
          emptyDir: {}
        {{- end }}
    {{- with .Values.st2sensorcontainer.nodeSelector }}
      nodeSelector:
{{ toYaml . | indent 8 }}
    {{- end }}
    {{- with .Values.st2sensorcontainer.affinity }}
      affinity:
{{ toYaml . | indent 8 }}
    {{- end }}
    {{- with .Values.st2sensorcontainer.tolerations }}
      tolerations:
{{ toYaml . | indent 8 }}
    {{- end }}

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Release.Name }}-st2actionrunner-enterprise
  labels:
    app: st2actionrunner
    tier: backend
    vendor: stackstorm
    support: {{ template "supportMethod" . }}
    chart: {{ .Chart.Name }}-{{ .Chart.Version }}
    release: {{ .Release.Name }}
    heritage: {{ .Release.Service }}
spec:
  selector:
    matchLabels:
      app: st2actionrunner
      support: {{ template "supportMethod" . }}
      release: {{ .Release.Name }}
  # https://docs.stackstorm.com/reference/ha.html#st2actionrunner
  # Multiple st2actionrunner processes can run in active-active with only connections to MongoDB and RabbitMQ. Work gets naturally
  # distributed across runners via RabbitMQ. Adding more st2actionrunner processes increases the ability of StackStorm to execute actions.
  replicas: {{ default 5 .Values.st2actionrunner.replicas }}
  template:
    metadata:
      labels:
        app: st2actionrunner
        tier: backend
        vendor: stackstorm
        support: {{ template "supportMethod" . }}
        chart: {{ .Chart.Name }}-{{ .Chart.Version }}
        release: {{ .Release.Name }}
        heritage: {{ .Release.Service }}
      annotations:
        checksum/config: {{ include (print $.Template.BasePath "/configmaps_st2-conf.yaml") . | sha256sum }}
        checksum/ssh: {{ include (print $.Template.BasePath "/secrets_ssh.yaml") . | sha256sum }}
    spec:
      {{- if .Values.enterprise.enabled }}
      imagePullSecrets:
      - name: {{ .Release.Name }}-st2-license
      {{- end }}
      {{- if .Values.st2.packs.image.repository }}
      initContainers:
      # Merge packs and virtualenvs from st2actionrunner-enterprise with those from the st2.packs image
      # Custom packs
      - name: st2-custom-packs
        image: "{{ .Values.st2.packs.image.repository }}/{{ .Values.st2.packs.image.name }}:{{ .Values.st2.packs.image.tag }}"
        imagePullPolicy: {{ .Values.st2.packs.image.pullPolicy | quote }}
        volumeMounts:
        - name: st2-packs-vol
          mountPath: /opt/stackstorm/packs-shared
        - name: st2-virtualenvs-vol
          mountPath: /opt/stackstorm/virtualenvs-shared
        command:
          - 'sh'
          - '-ec'
          - |
            /bin/cp -aR /opt/stackstorm/packs/. /opt/stackstorm/packs-shared &&
            /bin/cp -aR /opt/stackstorm/virtualenvs/. /opt/stackstorm/virtualenvs-shared
      # System packs
      - name: st2-system-packs
        image: "{{ .Values.image.repository }}/st2actionrunner-enterprise:{{ .Chart.AppVersion }}"
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        volumeMounts:
        - name: st2-packs-vol
          mountPath: /opt/stackstorm/packs-shared
        command:
          - 'sh'
          - '-ec'
          - |
            /bin/cp -aR /opt/stackstorm/packs/. /opt/stackstorm/packs-shared &&
            /bin/cp -aR /opt/stackstorm/virtualenvs/. /opt/stackstorm/virtualenvs-shared
      {{- end }}
      containers:
      - name: st2actionrunner-enterprise
        image: "{{ .Values.image.repository }}/st2actionrunner-enterprise:{{ .Chart.AppVersion }}"
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        # TODO: Add liveness/readiness probes (#3)
        #livenessProbe:
        #readinessProbe:
        envFrom:
        - configMapRef:
            name: {{ .Release.Name }}-st2-urls
        volumeMounts:
        - name: st2-config-vol
          mountPath: /etc/st2/st2.docker.conf
          subPath: st2.docker.conf
        - name: st2-config-vol
          mountPath: /etc/st2/st2.user.conf
          subPath: st2.user.conf
        - name: st2-ssh-key-vol
          mountPath: /home/stanley/.ssh/
          readOnly: true
        {{- if .Values.st2.packs.image.repository }}
        - name: st2-packs-vol
          mountPath: /opt/stackstorm/packs
          readOnly: true
        - name: st2-virtualenvs-vol
          mountPath: /opt/stackstorm/virtualenvs
          readOnly: true
        {{- end }}
        resources:
{{ toYaml .Values.st2actionrunner.resources | indent 10 }}
      volumes:
        - name: st2-config-vol
          configMap:
            name: {{ .Release.Name }}-st2-config
        - name: st2-ssh-key-vol
          secret:
            secretName: {{ .Release.Name }}-st2-ssh
            items:
            - key: private_key
              path: stanley_rsa
              # 0400 file permission
              mode: 256
        {{- if .Values.st2.packs.image.repository }}
        - name: st2-packs-vol
          emptyDir: {}
        - name: st2-virtualenvs-vol
          emptyDir: {}
        {{- end }}
    {{- with .Values.st2actionrunner.nodeSelector }}
      nodeSelector:
{{ toYaml . | indent 8 }}
    {{- end }}
    {{- with .Values.st2actionrunner.affinity }}
      affinity:
{{ toYaml . | indent 8 }}
    {{- end }}
    {{- with .Values.st2actionrunner.tolerations }}
      tolerations:
{{ toYaml . | indent 8 }}
    {{- end }}

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Release.Name }}-st2garbagecollector-enterprise
  labels:
    app: st2garbagecollector
    tier: backend
    vendor: stackstorm
    support: {{ template "supportMethod" . }}
    chart: {{ .Chart.Name }}-{{ .Chart.Version }}
    release: {{ .Release.Name }}
    heritage: {{ .Release.Service }}
spec:
  selector:
    matchLabels:
      app: st2garbagecollector
      support: {{ template "supportMethod" . }}
      release: {{ .Release.Name }}
  # https://docs.stackstorm.com/reference/ha.html#st2garbagecollector
  # Having 1 st2garbagecollector unique replica is enough for periodic task like st2 history garbage collection
  replicas: {{ default 1 .Values.st2garbagecollector.replicas }}
  template:
    metadata:
      labels:
        app: st2garbagecollector
        tier: backend
        vendor: stackstorm
        support: {{ template "supportMethod" . }}
        chart: {{ .Chart.Name }}-{{ .Chart.Version }}
        release: {{ .Release.Name }}
        heritage: {{ .Release.Service }}
      annotations:
        checksum/config: {{ include (print $.Template.BasePath "/configmaps_st2-conf.yaml") . | sha256sum }}
    spec:
      {{- if .Values.enterprise.enabled }}
      imagePullSecrets:
      - name: {{ .Release.Name }}-st2-license
      {{- end }}
      containers:
      - name: st2garbagecollector-enterprise
        image: "{{ .Values.image.repository }}/st2garbagecollector-enterprise:{{ .Chart.AppVersion }}"
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        # TODO: Add liveness/readiness probes (#3)
        #livenessProbe:
        #readinessProbe:
        envFrom:
        - configMapRef:
            name: {{ .Release.Name }}-st2-urls
        volumeMounts:
        - name: st2-config-vol
          mountPath: /etc/st2/st2.docker.conf
          subPath: st2.docker.conf
        - name: st2-config-vol
          mountPath: /etc/st2/st2.user.conf
          subPath: st2.user.conf
        resources:
{{ toYaml .Values.st2garbagecollector.resources | indent 10 }}
      volumes:
        - name: st2-config-vol
          configMap:
            name: {{ .Release.Name }}-st2-config
    {{- with .Values.st2garbagecollector.nodeSelector }}
      nodeSelector:
{{ toYaml . | indent 8 }}
    {{- end }}
    {{- with .Values.st2garbagecollector.affinity }}
      affinity:
{{ toYaml . | indent 8 }}
    {{- end }}
    {{- with .Values.st2garbagecollector.tolerations }}
      tolerations:
{{ toYaml . | indent 8 }}
    {{- end }}

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Release.Name }}-st2client-enterprise
  labels:
    app: st2client
    tier: backend
    vendor: stackstorm
    support: {{ template "supportMethod" . }}
    chart: {{ .Chart.Name }}-{{ .Chart.Version }}
    release: {{ .Release.Name }}
    heritage: {{ .Release.Service }}
spec:
  selector:
    matchLabels:
      app: st2client
      support: {{ template "supportMethod" . }}
      release: {{ .Release.Name }}
  replicas: 1
  template:
    metadata:
      labels:
        app: st2client
        tier: backend
        vendor: stackstorm
        support: {{ template "supportMethod" . }}
        chart: {{ .Chart.Name }}-{{ .Chart.Version }}
        release: {{ .Release.Name }}
        heritage: {{ .Release.Service }}
      annotations:
        checksum/config: {{ include (print $.Template.BasePath "/configmaps_st2-conf.yaml") . | sha256sum }}
        {{- if .Values.enterprise.enabled }}
        checksum/rbac: {{ include (print $.Template.BasePath "/configmaps_rbac.yaml") . | sha256sum }}
        {{- end }}
        checksum/packs: {{ include (print $.Template.BasePath "/configmaps_packs.yaml") . | sha256sum }}
        checksum/auth: {{ include (print $.Template.BasePath "/secrets_st2auth.yaml") . | sha256sum }}
        checksum/ssh: {{ include (print $.Template.BasePath "/secrets_ssh.yaml") . | sha256sum }}
    spec:
      {{- if .Values.enterprise.enabled }}
      imagePullSecrets:
      - name: {{ .Release.Name }}-st2-license
      {{- end }}
      initContainers:
      {{- if .Values.st2.packs.image.repository }}
      # Merge packs and virtualenvs from st2actionrunner-enterprise with those from the st2.packs image
      # Custom packs
      - name: st2-custom-packs
        image: "{{ .Values.st2.packs.image.repository }}/{{ .Values.st2.packs.image.name }}:{{ .Values.st2.packs.image.tag }}"
        imagePullPolicy: {{ .Values.st2.packs.image.pullPolicy | quote }}
        volumeMounts:
        - name: st2-packs-vol
          mountPath: /opt/stackstorm/packs-shared
        - name: st2-virtualenvs-vol
          mountPath: /opt/stackstorm/virtualenvs-shared
        command:
          - 'sh'
          - '-ec'
          - |
            /bin/cp -aR /opt/stackstorm/packs/. /opt/stackstorm/packs-shared &&
            /bin/cp -aR /opt/stackstorm/virtualenvs/. /opt/stackstorm/virtualenvs-shared
      # System packs
      - name: st2-system-packs
        image: "{{ .Values.image.repository }}/st2actionrunner-enterprise:{{ .Chart.AppVersion }}"
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        volumeMounts:
        - name: st2-packs-vol
          mountPath: /opt/stackstorm/packs-shared
        command:
          - 'sh'
          - '-ec'
          - |
            /bin/cp -aR /opt/stackstorm/packs/. /opt/stackstorm/packs-shared &&
            /bin/cp -aR /opt/stackstorm/virtualenvs/. /opt/stackstorm/virtualenvs-shared
      {{- end }}
      # Sidecar container for generating st2client config with st2 username & password pair and sharing produced file with the main container
      - name: generate-st2client-config
        image: "{{ .Values.image.repository }}/st2actionrunner-enterprise:{{ .Chart.AppVersion }}"
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        envFrom:
        - configMapRef:
            name: {{ .Release.Name }}-st2-urls
        env:
        - name: ST2_AUTH_USERNAME
          valueFrom:
            secretKeyRef:
              name: {{ .Release.Name }}-st2-auth
              key: username
        - name: ST2_AUTH_PASSWORD
          valueFrom:
            secretKeyRef:
              name: {{ .Release.Name }}-st2-auth
              key: password
        volumeMounts:
        - name: st2client-config-vol
          mountPath: /root/.st2/
        # `st2 login` doesn't exit on failure correctly, use old methods instead. See bug: https://github.com/StackStorm/st2/issues/4338
        command:
          - 'sh'
          - '-ec'
          - |
            cat <<EOT > /root/.st2/config
            [credentials]
            username = ${ST2_AUTH_USERNAME}
            password = ${ST2_AUTH_PASSWORD}
            EOT
      containers:
      - name: st2client-enterprise
        image: "{{ .Values.image.repository }}/st2actionrunner-enterprise:{{ .Chart.AppVersion }}"
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        env:
        - name: ST2CLIENT
          value: "1"
        envFrom:
        - configMapRef:
            name: {{ .Release.Name }}-st2-urls
        volumeMounts:
        - name: st2-config-vol
          mountPath: /etc/st2/st2.docker.conf
          subPath: st2.docker.conf
        - name: st2-config-vol
          mountPath: /etc/st2/st2.user.conf
          subPath: st2.user.conf
        {{- if .Values.enterprise.enabled }}
        - name: st2-rbac-roles-vol
          mountPath: /opt/stackstorm/rbac/roles/
        - name: st2-rbac-assignments-vol
          mountPath: /opt/stackstorm/rbac/assignments/
        - name: st2-rbac-mappings-vol
          mountPath: /opt/stackstorm/rbac/mappings/
        {{- end }}
        - name: st2-pack-configs-vol
          mountPath: /opt/stackstorm/configs/
        - name: st2client-config-vol
          mountPath: /root/.st2/
        - name: st2-ssh-key-vol
          mountPath: /home/stanley/.ssh/
          readOnly: true
        {{- if .Values.st2.packs.image.repository }}
        - name: st2-packs-vol
          mountPath: /opt/stackstorm/packs
          readOnly: true
        - name: st2-virtualenvs-vol
          mountPath: /opt/stackstorm/virtualenvs
          readOnly: true
        {{- end }}
        command:
          - 'bash'
          - '-ec'
          - 'while true; do sleep 999; done'
        resources:
          requests:
            memory: "5Mi"
            cpu: "5m"
      volumes:
        - name: st2-config-vol
          configMap:
            name: {{ .Release.Name }}-st2-config
        {{- if .Values.enterprise.enabled }}
        - name: st2-rbac-roles-vol
          configMap:
            name: {{ .Release.Name }}-st2-rbac-roles
        - name: st2-rbac-assignments-vol
          configMap:
            name: {{ .Release.Name }}-st2-rbac-assignments
        - name: st2-rbac-mappings-vol
          configMap:
            name: {{ .Release.Name }}-st2-rbac-mappings
        {{- end }}
        - name: st2-pack-configs-vol
          configMap:
            name: {{ .Release.Name }}-st2-pack-configs
        - name: st2client-config-vol
          emptyDir:
            medium: Memory
        - name: st2-ssh-key-vol
          secret:
            secretName: {{ .Release.Name }}-st2-ssh
            items:
            - key: private_key
              path: stanley_rsa
              # 0400 file permission
              mode: 256
        {{- if .Values.st2.packs.image.repository }}
        - name: st2-packs-vol
          emptyDir: {}
        - name: st2-virtualenvs-vol
          emptyDir: {}
        {{- end }}
